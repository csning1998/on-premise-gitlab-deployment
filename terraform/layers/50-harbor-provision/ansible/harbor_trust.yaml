---
- name: Configure MicroK8s Harbor Trust
  hosts: harbor_nodes
  become: true
  vars:
    harbor_domain: "harbor.iac.local"
    certs_dir: "/var/snap/microk8s/current/args/certs.d/{{ harbor_domain }}"

  tasks:
    - name: Detect Harbor Ingress IP from Kubernetes
      # Attempt to fetch Ingress Controller LoadBalancer IP first
      # If failed, attempt to fetch Harbor Ingress object IP
      shell: |
        export KUBECONFIG=/home/{{ ansible_user }}/.kube/config
        IP=$(kubectl get svc -n ingress-system -l app.kubernetes.io/name=ingress-nginx -o jsonpath='{.items[0].status.loadBalancer.ingress[0].ip}' 2>/dev/null)
        if [ -z "$IP" ]; then
          IP=$(kubectl get ingress -n harbor harbor-ingress -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null)
        fi
        echo $IP
      register: ingress_ip_output
      changed_when: false
      failed_when: ingress_ip_output.stdout == ""

    - name: Update /etc/hosts with correct Harbor IP
      lineinfile:
        path: /etc/hosts
        regexp: ".*{{ harbor_domain }}$"
        line: "{{ ingress_ip_output.stdout }} {{ harbor_domain }}"
        state: present

    - name: Create MicroK8s certs directory
      file:
        path: "{{ certs_dir }}"
        state: directory
        mode: "0755"

    - name: Fetch and Pin Harbor Certificate (Force Refresh)
      shell: |
        echo -n | openssl s_client -connect {{ harbor_domain }}:443 -servername {{ harbor_domain }} 2>/dev/null | openssl x509 > {{ certs_dir }}/ca.crt
      args:
        creates: "" # Always run to ensure the latest certificate
      register: fetch_cert

    - name: Create hosts.toml for Containerd
      copy:
        dest: "{{ certs_dir }}/hosts.toml"
        content: |
          server = "https://{{ harbor_domain }}"

          [host."https://{{ harbor_domain }}"]
            capabilities = ["pull", "resolve"]
            ca = "{{ certs_dir }}/ca.crt"

    - name: Restart MicroK8s Containerd (if config or cert changed)
      command: snap restart microk8s.daemon-containerd
      # Restart when hosts.toml changes or certificate is refreshed
      when: fetch_cert.changed

    - name: Verify Connectivity (Allow 200 or 401)
      shell: |
        curl --silent --output /dev/null --write-out "%{http_code}" --cacert "{{ certs_dir }}/ca.crt" "https://{{ harbor_domain }}/v2/"
      register: curl_check
      failed_when: false
      changed_when: false
      until:
        - curl_check.rc == 0
        - curl_check.stdout == "200" or curl_check.stdout == "401"
      retries: 20
      delay: 5

    - name: Ensure .kube directory exists
      file:
        path: "/home/{{ ansible_user }}/.kube"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"

    - name: Generate kubeconfig from MicroK8s
      shell: microk8s config > /home/{{ ansible_user }}/.kube/config
      args:
        creates: "/home/{{ ansible_user }}/.kube/config"

    - name: Set permissions on kubeconfig
      file:
        path: "/home/{{ ansible_user }}/.kube/config"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0600"

    - name: Get current Harbor Registry ConfigMap
      kubernetes.core.k8s_info:
        kubeconfig: "/home/{{ ansible_user }}/.kube/config"
        kind: ConfigMap
        name: harbor-registry
        namespace: harbor
      register: harbor_cm

    - name: Inject forcepathstyle into config.yml content
      set_fact:
        patched_config_content: >-
          {{ 
            harbor_cm.resources[0].data['config.yml'] 
            | regex_replace(
                '(regionendpoint: .*)', 
                '\1\n    forcepathstyle: true'
              ) 
          }}
      when: "'forcepathstyle: true' not in harbor_cm.resources[0].data['config.yml']"

    - name: Apply Patched ConfigMap
      kubernetes.core.k8s:
        kubeconfig: "/home/{{ ansible_user }}/.kube/config"
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: harbor-registry
            namespace: harbor
          data:
            config.yml: "{{ patched_config_content | default(harbor_cm.resources[0].data['config.yml']) }}"
      when: "'forcepathstyle: true' not in harbor_cm.resources[0].data['config.yml']"

    - name: Restart Harbor Registry Pods to pick up changes
      kubernetes.core.k8s:
        kubeconfig: "/home/{{ ansible_user }}/.kube/config"
        state: absent
        kind: Pod
        namespace: harbor
        label_selectors:
          - component=registry
      when: "'forcepathstyle: true' not in harbor_cm.resources[0].data['config.yml']"
