---
- name: "Section A: Install PostgreSQL Server via Official Apt Repository"
  become: true
  block:
    - name: "Step 1. Ensure PostgreSQL common GPG key directory exists"
      ansible.builtin.file:
        path: "{{ _postgres_base_repo_data.gpg_store_path | dirname }}"
        state: directory
        mode: "0755"

    - name: "Step 2. Import the PostgreSQL repository signing key"
      ansible.builtin.get_url:
        url: "{{ _postgres_base_repo_data.gpg_url }}"
        dest: "{{ _postgres_base_repo_data.gpg_store_path }}"
        mode: "0644"
      register: gpg_key_result
      until: gpg_key_result is succeeded
      retries: 5
      delay: 2

    - name: "Step 3. Create the PostgreSQL repository configuration file"
      ansible.builtin.apt_repository:
        repo: "{{ _postgres_base_repo_string }}"
        state: present
        filename: "{{ _postgres_base_repo_data.filename }}"

    - name: "Step 4. Install PostgreSQL server and client packages (Version {{ postgres_base.versions.postgres }})"
      ansible.builtin.apt:
        name: "{{ _postgres_base_versioned_packages }}"
        state: present
        update_cache: true
