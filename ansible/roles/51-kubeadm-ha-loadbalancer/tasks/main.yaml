- name: "Block A: Dynamically discover the Host-only network interface (Ansible Native)"
  block:
    - name: "Step 1. Identify Host-only interface from facts"
      ansible.builtin.set_fact:
        kubeadm_ha_interface: "{{ item }}"
      loop: "{{ ansible_facts.interfaces }}"
      when:
        - item != 'lo'
        - ansible_facts[item]['ipv4'] is defined
        - not (ansible_facts[item]['ipv4']['address'].startswith(k8s_nat_subnet_prefix))

    - name: "Step 2. Print discovered interface"
      ansible.builtin.debug:
        msg: "Discovered HA Interface: {{ kubeadm_ha_interface }} (Address: {{ ansible_facts[kubeadm_ha_interface]['ipv4']['address'] }})"
      when: kubeadm_ha_interface is defined

    - name: "Step 3. Fail if Host-only interface could not be determined"
      ansible.builtin.fail:
        msg: "Could not dynamically determine the Host-Only network interface using prefix exclusion."
      when: kubeadm_ha_interface is not defined or kubeadm_ha_interface | length == 0

- name: "Block B: Install and Configure HA Services"
  block:
    - name: "Step 1. Enable non-local binding (Required for VIP)"
      ansible.posix.sysctl:
        name: "net.ipv4.ip_nonlocal_bind"
        value: "1"
        state: present
        reload: true

    - name: "Step 2. Install HAProxy and Keepalived"
      ansible.builtin.apt:
        name:
          - keepalived
          - haproxy
          - rsyslog
        state: present
        update_cache: true

    - name: "Step 3. Create keepalived_script user"
      ansible.builtin.user:
        name: "keepalived_script"
        system: true
        shell: "/usr/sbin/nologin"
        state: present

- name: "Block C: Configure Services"
  block:
    - name: "Step 1. Configure Keepalived"
      ansible.builtin.template:
        src: keepalived.conf.j2
        dest: /etc/keepalived/keepalived.conf
        mode: "0644"
        validate: keepalived --config-test %s
      notify: Restart keepalived

    - name: "Step 2. Configure HAProxy"
      ansible.builtin.template:
        src: haproxy.cfg.j2
        dest: /etc/haproxy/haproxy.cfg
        mode: "0640"
        validate: haproxy -c -f %s
      notify: Restart haproxy

    - name: "Step 3. Configure Rsyslog for Keepalived"
      ansible.builtin.lineinfile:
        path: /etc/rsyslog.conf
        line: "local0.* /var/log/keepalived.log"
        create: true
        mode: "0644"
      notify: Restart rsyslog
      changed_when: false

    - name: "4. Ensure services are started and enabled"
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: started
        enabled: true
        daemon_reload: true
      loop:
        - keepalived
        - haproxy
