global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log global
    mode tcp
    option tcplog
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

listen redis_cluster
    bind *:{{ haproxy_stats_port }}
    mode tcp
    balance first
    option tcp-check
    
    # Redis Health Check with Auth
    tcp-check connect
    tcp-check send AUTH\ {{ redis_requirepass }}\r\n
    tcp-check expect string +OK
    tcp-check send info\ replication\r\n
    tcp-check expect string role:master

    # Point to Redis cluster nodes injected from Terraform
{% for ip in redis_cluster_ips %}
    server redis-{{ loop.index }} {{ ip }}:6379 check inter 3s fall 3 rise 2
{% endfor %}
