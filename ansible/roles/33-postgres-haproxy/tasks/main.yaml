---
- name: "Block A: Dynamically discover the Host-only network interface"
  block:
    - name: "Step 1. Identify Host-only interface from facts"
      ansible.builtin.set_fact:
        postgres_ha_interface: "{{ item }}"
      loop: "{{ ansible_facts.interfaces }}"
      when:
        - item != 'lo'
        - ansible_facts[item]['ipv4'] is defined
        - not (ansible_facts[item]['ipv4']['address'].startswith(postgres_nat_subnet_prefix))

    - name: "Step 2. Print discovered interface"
      ansible.builtin.debug:
        msg: "Discovered HA Interface: {{ postgres_ha_interface }} (Address: {{ ansible_facts[postgres_ha_interface]['ipv4']['address'] }})"
      when: postgres_ha_interface is defined

    - name: "Step 3. Fail if Host-only interface could not be determined"
      ansible.builtin.fail:
        msg: "Could not dynamically determine the Host-Only network interface."
      when: postgres_ha_interface is not defined or postgres_ha_interface | length == 0

- name: "Block B: Install and Configure HA Services"
  block:
    - name: "Step 1. Enable non-local binding (Required for VIP)"
      ansible.posix.sysctl:
        name: "net.ipv4.ip_nonlocal_bind"
        value: "1"
        state: present
        reload: true

    - name: "Step 2. Install HAProxy and Keepalived"
      ansible.builtin.apt:
        name:
          - haproxy
          - keepalived
        state: present
        update_cache: true

    - name: "Step 3. Configure Keepalived"
      ansible.builtin.template:
        src: keepalived.conf.j2
        dest: /etc/keepalived/keepalived.conf
        mode: "0644"
      notify: Restart Keepalived

    - name: "Step 4. Configure HAProxy"
      ansible.builtin.template:
        src: haproxy.cfg.j2
        dest: /etc/haproxy/haproxy.cfg
        mode: "0644"
      notify: Restart HAProxy

- name: "Block C: Start Services"
  block:
    - name: "Step 1. Enable and start services"
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: started
        enabled: true
        daemon_reload: true
      loop:
        - keepalived
        - haproxy
