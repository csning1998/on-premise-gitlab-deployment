---
- name: "Block A: Ensure Snapd service is ready"
  become: true
  block:
    - name: "Step A2. Ensure snapd service is started and enabled"
      ansible.builtin.systemd:
        name: "{{ microk8s_base.prereq_service }}"
        state: started
        enabled: true

    - name: "Step A3. Wait for snapd to become fully ready"
      ansible.builtin.command:
        cmd: "{{ microk8s_base.commands.wait_snapd }}"
      changed_when: false
      retries: 10
      delay: 5

- name: "Block B: Install MicroK8s and create aliases"
  become: true
  block:
    - name: "Step B1. Install MicroK8s via Snap"
      community.general.snap:
        name: "{{ microk8s_base.snap_config.name }}"
        classic: "{{ microk8s_base.snap_config.classic }}"
        channel: "{{ microk8s_base.snap_config.channel }}"

    - name: "Step B2. Wait for MicroK8s to be ready"
      ansible.builtin.command:
        cmd: "{{ microk8s_base.commands.wait_ready }}"
      changed_when: false

    - name: "Step B3. Create MicroK8s aliases (kubectl, helm)"
      ansible.builtin.command:
        cmd: "snap alias {{ item.src }} {{ item.alias_name }}"
      args:
        creates: "{{ item.creates_path }}"
      loop: "{{ microk8s_base.aliases }}"

    - name: "Step B4. Ensure Python Kubernetes library for Ansible is installed"
      ansible.builtin.pip:
        name: kubernetes
        state: present
        extra_args: "--break-system-packages"

- name: "Block C: Add SSH user to the 'microk8s' group for basic access"
  become: true
  block:
    - name: "Step C1. Add user to the 'microk8s' group"
      ansible.builtin.user:
        name: "{{ ssh_user }}"
        groups: "{{ microk8s_base.user_group }}"
        append: true

- name: "Block D: Reset MicroK8s state for golden image"
  become: true
  block:
    - name: "Step D1. Leave the current cluster to reset node state"
      ansible.builtin.command:
        cmd: "{{ microk8s_base.commands.reset }}"
      changed_when: true

    - name: "Step D2. Stop the MicroK8s service for clean state"
      ansible.builtin.command:
        cmd: "{{ microk8s_base.commands.stop }}"
      changed_when: true
