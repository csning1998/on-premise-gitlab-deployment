---
- name: "Block E: Initialize Vault Cluster (Primary Only)"
  become: true
  run_once: true
  block:
    - name: "E1. Wait for Vault"
      ansible.builtin.wait_for:
        port: "{{ vault_port_api }}"
        delay: "{{ vault_wait_delay_seconds }}"

    - name: "E2. Initialize Vault"
      ansible.builtin.command: >
        vault operator init \
        -key-shares={{ vault_init_key_shares }} \
        -key-threshold={{ vault_init_key_threshold }} \
        -format=json
      environment:
        VAULT_ADDR: "https://127.0.0.1:{{ vault_port_api }}"
        VAULT_SKIP_VERIFY: "true"
      register: init_result
      ignore_errors: true

    - name: "E3. Save Keys to Local"
      ansible.builtin.copy:
        content: "{{ init_result.stdout | from_json | to_nice_json(indent=2) }}"
        dest: "{{ playbook_dir }}/../fetched/{{ service_identifier }}/vault_init_output.json"
        mode: "0600"
      delegate_to: localhost
      become: false
      when: init_result.rc == 0
