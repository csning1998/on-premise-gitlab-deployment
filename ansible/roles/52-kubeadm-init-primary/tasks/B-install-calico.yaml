---
### For the purpose of testing cluster only.
- name: "Block A: Install Container Network Interface (CNI)"
  block:
    - name: "Step 1. Install the Tigera Calico operator"
      ansible.builtin.command: >-
        kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/tigera-operator.yaml
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      args:
        creates: /etc/kubernetes/calico-operator-installed.flag
      register: calico_operator_create
      changed_when: "'created' in calico_operator_create.stdout"

    - name: "Step 2. Download Calico custom resources manifest"
      ansible.builtin.get_url:
        url: "https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/custom-resources.yaml"
        dest: "/tmp/calico-custom-resources.yaml"
        mode: "0644"

    - name: "Step 3. Update Calico manifest with the correct pod CIDR"
      ansible.builtin.replace:
        path: "/tmp/calico-custom-resources.yaml"
        regexp: "cidr: 192.168.0.0/16"
        replace: "cidr: {{ kubeadm_pod_subnet }}"

    - name: "Step 4. Apply the customized Calico resources"
      ansible.builtin.command: kubectl apply -f /tmp/calico-custom-resources.yaml
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: calico_apply
      changed_when: "'created' in calico_apply.stdout or 'configured' in calico_apply.stdout"

- name: "Block B: Wait for API server to become responsive after CNI"
  ansible.builtin.wait_for:
    host: "{{ kubeadm_advertise_ip }}"
    port: 6443
    delay: 15
    timeout: 180
    msg: "API server did not become responsive within 3 minutes after CNI installation."
